pipeline {
   agent { label "android"}
   stages {
      stage('Unit test') {
          steps {
              withEnv(['GRADLE_HOME=/var/jenkins_home/tools/gradle', 'GRADLE_OPTS="-Dorg.gradle.daemon=true -Xmx1024m -Xms512m -XX:MaxPermSize=2048m"', 'ANDROID_HOME=/var/jenkins_home/tools/android-sdk']) {
                  sh '$GRADLE_HOME/bin/gradle clean testDebug'
              }
          }
          post {
            always {
                junit(allowEmptyResults: true, testResults: '**/*.xml')
            }
          }
      }
      stage('Code coverage') {
          steps {
            withEnv(['GRADLE_HOME=/var/jenkins_home/tools/gradle', 'GRADLE_OPTS="-Dorg.gradle.daemon=true -Xmx1024m -Xms512m -XX:MaxPermSize=2048m"', 'ANDROID_HOME=/var/jenkins_home/tools/android-sdk']) {
                  sh '$GRADLE_HOME/bin/gradle clean sonarComplete'
            }
          }
          post {
             success {
                androidLint canComputeNew: false, defaultEncoding: '', healthy: '', pattern: '**/build/reports/lint-results*.xml', unHealthy: ''
                publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: false, reportDir: 'app/build/reports/jacoco/jacocoTestDebugUnitTestReport/html', reportFiles: 'index.html', reportName: 'Code coverage', reportTitles: 'Code coverage'])
             }
          }
      }
     stage ('Package and Publish'){
         steps {
            withEnv(['GRADLE_HOME=/var/jenkins_home/tools/gradle', 'GRADLE_OPTS="-Dorg.gradle.daemon=true -Xmx1024m -Xms512m -XX:MaxPermSize=2048m"', 'ANDROID_HOME=/var/jenkins_home/tools/android-sdk']) {
                def changes = ""
                sh './bundle-db.sh'
                sh '$GRADLE_HOME/bin/gradle clean assembleRelease'
                env.WORKSPACE = pwd()
                changes = readFile "${env.WORKSPACE}/changelist"
            }
         }
         post {
            success {
                 archive includes:'**/*.apk'
                 androidApkUpload apkFilesPattern: '**/*.apk', googleCredentialsId: 'app-publish', recentChangeList: [[language: 'en-GB', text: changes]], trackName: 'beta'
            }
         }
     }
   }
}
